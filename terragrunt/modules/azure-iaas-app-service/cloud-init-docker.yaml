#cloud-config
package_update: true
package_upgrade: true

packages:
  - docker.io
  - docker-compose-plugin
  - curl

write_files:
  # Fichier .env pour l'app (placeholder)
  - path: /opt/app/.env
    permissions: "0644"
    content: |
      # ACR / App image
      ACR_LOGIN_SERVER=${acr_login_server}
      DOCKER_IMAGE=${docker_image}
      DOCKER_IMAGE_TAG=${docker_image_tag}

      # DB
      DB_HOST=${db_host}
      DB_NAME=${db_name}
      DB_USERNAME=${db_username}
      DB_PASSWORD=${db_password}

      # App settings sérialisés (placeholder, vrai usage via Ansible)
      APP_SETTINGS_JSON='${app_settings}'

  # docker-compose pour Traefik + App (placeholder)
  - path: /opt/app/docker-compose.yml
    permissions: "0644"
    content: |
      version: "3.8"

      services:
        traefik:
          image: traefik:v3.0
          container_name: traefik
          command:
            - "--api.dashboard=true"
            - "--providers.docker=true"
            - "--providers.docker.exposedbydefault=false"
            - "--entrypoints.web.address=:80"
          ports:
            - "80:80"
            - "8080:8080"
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
          networks:
            - app-net
          labels:
            - "traefik.enable=true"
            - "traefik.http.routers.traefik.rule=PathPrefix(`/traefik`)"
            - "traefik.http.routers.traefik.service=api@internal"

        app:
          # Placeholder: image ACR – la vraie CD sera faite par Ansible + GitHub Actions
          image: ${acr_login_server}/${docker_image}:${docker_image_tag}
          container_name: app
          restart: unless-stopped
          env_file:
            - /opt/app/.env
          networks:
            - app-net
          labels:
            - "traefik.enable=true"
            - "traefik.http.routers.app.rule=PathPrefix(`/`)"
            - "traefik.http.routers.app.entrypoints=web"
            - "traefik.http.services.app.loadbalancer.server.port=80"

      networks:
        app-net:
          driver: bridge

  # Service systemd pour gérer la stack Docker
  - path: /etc/systemd/system/app-stack.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Docker Compose App Stack
      Requires=docker.service
      After=docker.service

      [Service]
      WorkingDirectory=/opt/app
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      Restart=always
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target

runcmd:
  # S'assurer que les paquets Docker sont bien installés
  - apt-get update
  - apt-get install -y docker.io docker-compose-plugin curl

  # Créer le dossier de l'app
  - mkdir -p /opt/app

  # Ajouter azureuser au groupe docker
  - usermod -aG docker azureuser

  # Activer Docker
  - systemctl enable docker
  - systemctl start docker

  # Recharger systemd et démarrer la stack
  - systemctl daemon-reload
  - systemctl enable app-stack
  - systemctl start app-stack


final_message: "TerraCloud VM ready: Docker + Traefik placeholder stack déployée. La véritable CD sera faite via Ansible/GitHub Actions."
